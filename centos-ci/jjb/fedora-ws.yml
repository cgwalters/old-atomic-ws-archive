- job:
    name: atomic-fedora-ws
    node: atomic-sig-ci-slave01 
    description: |
      See https://fedoraproject.org/wiki/Changes/WorkstationOstree

      From inside an existing system:
      <pre>
      yum -y install ostree ostree-grub2
      ostree admin init-fs /
      ostree remote add --set=gpg-verify=false fedora-ws-centosci https://ci.centos.org/artifacts/sig-atomic/rdgo/fedora-workstation/ostree/repo/
      ostree --repo=/ostree/repo pull fedora-ws-centosci:fedora/24/x86_64/desktop/continuous
      ostree admin os-init fedora
      ostree admin deploy --os=fedora --karg-proc-cmdline --karg=enforcing=0 fedora-ws-centosci:fedora/24/x86_64/desktop/continuous
      cp /etc/fstab /ostree/deploy/fedora/deploy/$checksum.0/etc
        (You may need to modify the fstab)
      grub2-mkconfig -o /boot/grub2/grub.cfg
      </pre>

      If you already deployed F23 and want to rebase to F24:
      <pre>
        rpm-ostree rebase fedora/24/x86_64/desktop_continuous
      </pre>
    scm:
      - fedora-ws-scms
    triggers:
      - github
      - timed: "H/30 * * * *"

    defaults: fedora-ws-defaults

    builders:
      - macro-cciskel-duffy-prepared-allocate:
          jobclass: builder
          duffytimeoutsecs: 3600
          playbook: workstation-ostree-config/centos-ci/setup/setup-system.yml
      - shell: |
          #!/bin/bash
          set -xeuo pipefail

          (echo -n "export RSYNC_PASSWORD=" && cat ~/duffy.key | cut -c '-13') > rsync-password.sh

          rsync -q -Hrlptv --stats -e ssh workstation-ostree-config rsync-password.sh builder@${DUFFY_HOST}:
          build_success=true
          if ! ssh -tt -i ${WORKSPACE}/builder.key builder@${DUFFY_HOST} ./workstation-ostree-config/centos-ci/run-build-and-rsync; then
            build_success=false
          fi
          rsync -q -Hrlptv --stats -e ssh builder@${DUFFY_HOST}:build-logs $WORKSPACE/build-logs || true
          # Exit with code from the build
          if test "${build_success}" = "false"; then
            echo 'Build failed, see logs above'; exit 1
          fi
            
    publishers:
      - archive:
          artifacts: 'build-logs/**'
          allow-empty: 'true'
      - macro-cciskel-duffy-deallocate

# create the jobs using the job templates
- project:
    name: atomic-rdgo
    jobs:
      - atomic-fedora-ws
